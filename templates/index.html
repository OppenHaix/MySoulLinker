{% extends "base.html" %}

{% block title %}è”ç³»äººåˆ—è¡¨ - æˆ‘çš„æ·±åº¦ç¤¾äº¤ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>è”ç³»äºº</h1>
    <p class="subtitle">ç®¡ç†ä½ çš„ç¤¾äº¤å…³ç³»ï¼Œå‘ç°æ·±å±‚è¿æ¥</p>
</div>

<div class="toolbar">
    <button class="btn btn-primary" onclick="showNewContactModal()">
        <span class="icon">+</span> æ–°å»º
    </button>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœç´¢è”ç³»äºº..." oninput="filterContacts()">
    </div>
</div>

<div class="contacts-list" id="contactsGrid">
    {% for contact in contacts %}
    <div class="contact-row" data-id="{{ contact.id }}" data-name="{{ contact.name }}" onclick="handleCardClick(event, {{ contact.id }})">
        <div class="contact-avatar">
            <img src="https://ui-avatars.com/api/?name={{ contact.name[:1] }}&background=fff&color=4a6cf7&size=48" alt="{{ contact.name }}">
            {% if contact.analysis %}
            <span class="contact-ai-badge">AI</span>
            {% endif %}
        </div>
        
        <div class="contact-info">
            <div class="contact-main">
                <h3 class="contact-name">{{ contact.name }}</h3>
                {% if contact.tags %}
                <div class="contact-tags">
                    {% for tag in contact.tags.split(',')[:2] %}
                    <span class="tag-chip">{{ tag.strip() }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            {% if contact.analysis %}
            <div class="contact-summary">
                {{ contact.analysis.summary[:60] }}...
            </div>
            {% endif %}
        </div>
        
        <div class="contact-stats">
            <div class="stat">
                <span class="stat-num">{{ contact.chat_count }}</span>
                <span class="stat-text">æ¶ˆæ¯</span>
            </div>
            <div class="stat">
                <span class="stat-num">{{ contact.active_days|default(0) }}</span>
                <span class="stat-text">æ´»è·ƒå¤©</span>
            </div>
        </div>
        
        <div class="contact-activity">
            {% set activity_level = contact.activity_level|default('low') %}
            <div class="activity-indicator">
                <div class="activity-bar">
                    <div class="activity-fill {{ activity_level }}" style="width: {{ contact.activity_percent|default(20) }}%"></div>
                </div>
                <span class="activity-label">{{ activity_level_text(contact.activity_level) }}</span>
            </div>
        </div>
        
        <div class="contact-actions" onclick="event.stopPropagation()">
            <a href="{{ url_for('labeling_page', contact_id=contact.id) }}" class="btn btn-small" title="å¯¼å…¥èŠå¤©">å¯¼å…¥</a>
            <a href="{{ url_for('profile_page', contact_id=contact.id) }}" class="btn btn-small btn-primary" title="æŸ¥çœ‹è¯¦æƒ…">åˆ†æ</a>
            <button class="btn btn-small btn-danger" onclick="deleteContact({{ contact.id }}, '{{ contact.name }}')" title="åˆ é™¤">åˆ é™¤</button>
        </div>
        
        <div class="contact-time">
            {{ contact.last_active|default('æš‚æ— ') }}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ‘¥</div>
        <h3>è¿˜æ²¡æœ‰è”ç³»äºº</h3>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ–°å»ºè”ç³»äººï¼Œå¼€å§‹è®°å½•ä½ çš„ç¤¾äº¤å…³ç³»</p>
        <button class="btn btn-primary btn-large" onclick="showNewContactModal()">
            <span class="icon">+</span> æ–°å»ºè”ç³»äºº
        </button>
    </div>
    {% endfor %}
</div>

<script>
function activity_level_text(level) {
    const texts = {high: 'é«˜æ´»è·ƒ', medium: 'ä¸­æ´»è·ƒ', low: 'ä½æ´»è·ƒ'};
    return texts[level] || texts.low;
}

function handleCardClick(event, contactId) {
    if (!event.target.closest('.btn') && !event.target.closest('button')) {
        window.location.href = `/profile/${contactId}`;
    }
}
</script>

<div class="modal" id="contactModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">æ–°å»ºè”ç³»äºº</h2>
            <button class="modal-close" onclick="closeModal('contactModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="contactForm">
                <input type="hidden" id="contactId">
                <div class="form-group">
                    <label for="contactName">å§“å/æ˜µç§°</label>
                    <input type="text" id="contactName" required placeholder="è¾“å…¥è”ç³»äººå§“å">
                </div>
                <div class="form-group">
                    <label for="contactAvatar">å¤´åƒURLï¼ˆå¯é€‰ï¼‰</label>
                    <input type="url" id="contactAvatar" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡é“¾æ¥">
                </div>
                <div class="form-group">
                    <label for="contactTags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="contactTags" placeholder="æœ‹å‹,åŒäº‹,å®¶äºº...">
                </div>
                <div class="form-group">
                    <label for="contactNotes">å¤‡æ³¨</label>
                    <textarea id="contactNotes" rows="3" placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('contactModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveContact()">ä¿å­˜</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const contacts = {{ contacts|tojson }};

function showNewContactModal() {
    document.getElementById('modalTitle').textContent = 'æ–°å»ºè”ç³»äºº';
    document.getElementById('contactId').value = '';
    document.getElementById('contactForm').reset();
    document.getElementById('contactModal').classList.add('show');
}

function filterContacts() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.contact-row').forEach(row => {
        const name = row.dataset.name.toLowerCase();
        row.style.display = name.includes(query) ? '' : 'none';
    });
}

async function saveContact() {
    const data = {
        name: document.getElementById('contactName').value,
        avatar: document.getElementById('contactAvatar').value,
        tags: document.getElementById('contactTags').value,
        notes: document.getElementById('contactNotes').value
    };
    
    if (!data.name) {
        alert('è¯·è¾“å…¥è”ç³»äººå§“å');
        return;
    }
    
    try {
        const response = await fetch('/api/contacts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            closeModal('contactModal');
            location.reload();
        } else {
            alert('ä¿å­˜å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ä¿å­˜å¤±è´¥');
    }
}

async function deleteContact(id, name) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤è”ç³»äºº"${name}"å—ï¼Ÿæ‰€æœ‰ç›¸å…³èŠå¤©è®°å½•å’Œåˆ†æç»“æœéƒ½å°†è¢«åˆ é™¤ã€‚`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/contacts/${id}`, { method: 'DELETE' });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('åˆ é™¤å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('åˆ é™¤å¤±è´¥');
    }
}
</script>
{% endblock %}

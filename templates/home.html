{% extends "base.html" %}

{% block title %}ä¸»é¡µ - MySoulLinker{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1>{% if username %}æ¬¢è¿å›æ¥ï¼Œ{{ username }}{% else %}{{ greeting }}{% endif %}</h1>
            <p class="subtitle">è¿™é‡Œæ˜¯æ‚¨çš„ç¤¾äº¤å…³ç³»ç®¡ç†ä¸­å¿ƒ</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="showNewContactModal()">
                <span class="btn-icon">â•</span> æ–°å»ºè”ç³»äºº
            </button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-content">
                <span class="stat-number">{{ stats.total_contacts }}</span>
                <span class="stat-label">è”ç³»äºº</span>
            </div>
            <div class="stat-trend up">
                <span class="trend-icon">â†‘</span>
                <span>{{ stats.new_this_month }} æ–°å¢</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ’¬</div>
            <div class="stat-content">
                <span class="stat-number">{{ stats.total_messages }}</span>
                <span class="stat-label">æ¶ˆæ¯è®°å½•</span>
            </div>
            <div class="stat-trend">
                <span>å…± {{ stats.total_contacts }} ä½è”ç³»äºº</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ¤–</div>
            <div class="stat-content">
                <span class="stat-number">{{ stats.total_analyses }}</span>
                <span class="stat-label">AIåˆ†æ</span>
            </div>
            <div class="stat-trend">
                <span>{{ stats.analysis_rate }}% åˆ†æç‡</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ”¥</div>
            <div class="stat-content">
                <span class="stat-number">{{ stats.active_relationships }}</span>
                <span class="stat-label">æ´»è·ƒå…³ç³»</span>
            </div>
            <div class="stat-trend">
                <span>è¿‘30å¤©æœ‰äº’åŠ¨</span>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card quick-actions">
            <div class="card-header">
                <h2>âš¡ å¿«æ·æ“ä½œ</h2>
            </div>
            <div class="action-grid">
                <div class="action-item" onclick="showNewContactModal()">
                    <div class="action-icon">ğŸ‘¤</div>
                    <span class="action-label">æ·»åŠ è”ç³»äºº</span>
                </div>
                <div class="action-item" onclick="selectContactForAction('import')">
                    <div class="action-icon">ğŸ“¥</div>
                    <span class="action-label">å¯¼å…¥èŠå¤©è®°å½•</span>
                </div>
                <div class="action-item" onclick="selectContactForAction('analysis')">
                    <div class="action-icon">ğŸ§ </div>
                    <span class="action-label">AIåˆ†æ</span>
                </div>
                <div class="action-item" onclick="selectContactForAction('export')">
                    <div class="action-icon">ğŸ“¤</div>
                    <span class="action-label">å¯¼å‡ºæ•°æ®</span>
                </div>
            </div>
        </div>

        <div class="card recent-contacts">
            <div class="card-header">
                <h2>ğŸ“… æœ€è¿‘è”ç³»äºº</h2>
                <a href="{{ url_for('contacts_page') }}" class="view-all">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
            </div>
            <div class="contacts-list">
                {% for contact in recent_contacts %}
                <div class="contact-item" onclick="viewContact({{ contact.id }})">
                    <div class="contact-avatar">
                        <img src="https://ui-avatars.com/api/?name={{ contact.name[:1] }}&background=fff&color=4a6cf7&size=40" alt="{{ contact.name }}">
                    </div>
                    <div class="contact-info">
                        <span class="contact-name">{{ contact.name }}</span>
                        <span class="contact-meta">
                            {% if contact.chat_count %}{{ contact.chat_count }} æ¡æ¶ˆæ¯{% endif %}
                        </span>
                    </div>
                    <div class="contact-status">
                        {% if contact.has_analysis %}
                        <span class="status-badge analyzed">å·²åˆ†æ</span>
                        {% else %}
                        <span class="status-badge pending">å¾…åˆ†æ</span>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>è¿˜æ²¡æœ‰è”ç³»äººï¼Œå¼€å§‹æ·»åŠ å§ï¼</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card need-attention">
            <div class="card-header">
                <h2>âš ï¸ éœ€è¦å…³æ³¨</h2>
            </div>
            <div class="attention-list">
                {% for contact in need_attention %}
                <div class="attention-item" onclick="viewContact({{ contact.id }})">
                    <div class="attention-icon">ğŸ””</div>
                    <div class="attention-content">
                        <span class="attention-title">{{ contact.name }}</span>
                        <span class="attention-desc">{{ contact.reason }}</span>
                    </div>
                    <span class="attention-action">æŸ¥çœ‹ â†’</span>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>æ‰€æœ‰å…³ç³»éƒ½å¤„ç†å¾—å¾ˆå¥½ï¼ğŸ‰</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card relationship-insights">
            <div class="card-header">
                <h2>ğŸŒŸ å…³ç³»æ´å¯Ÿ</h2>
            </div>
            <div class="insights-content">
                {% if insights %}
                <div class="insight-card">
                    <span class="insight-label">å¹³å‡æ¶ˆæ¯æ•°</span>
                    <span class="insight-value">{{ insights.avg_messages_per_contact }}</span>
                </div>
                <div class="insight-card">
                    <span class="insight-label">æœ€æ´»è·ƒè”ç³»äºº</span>
                    <span class="insight-value">{{ insights.most_active_contact }}</span>
                </div>
                <div class="insight-card">
                    <span class="insight-label">åˆ†æè¦†ç›–ç‡</span>
                    <span class="insight-value">{{ insights.analysis_coverage }}%</span>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>æ·»åŠ æ›´å¤šè”ç³»äººæ¥è·å–æ´å¯Ÿ</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card activity-chart">
            <div class="card-header">
                <h2>ğŸ“Š äº’åŠ¨æ´»è·ƒåº¦</h2>
                <select id="activityRange" onchange="updateActivityChart()">
                    <option value="7">è¿‘7å¤©</option>
                    <option value="30" selected>è¿‘30å¤©</option>
                    <option value="90">è¿‘90å¤©</option>
                </select>
            </div>
            <div class="chart-container" id="activityChart">
                <canvas id="activityCanvas"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="contactModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">æ–°å»ºè”ç³»äºº</h2>
            <button class="modal-close" onclick="closeModal('contactModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="contactForm">
                <input type="hidden" id="contactId">
                <div class="form-group">
                    <label for="contactName">å§“å/æ˜µç§°</label>
                    <input type="text" id="contactName" required placeholder="è¾“å…¥è”ç³»äººå§“å">
                </div>
                <div class="form-group">
                    <label for="contactAvatar">å¤´åƒURLï¼ˆå¯é€‰ï¼‰</label>
                    <input type="url" id="contactAvatar" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡é“¾æ¥">
                </div>
                <div class="form-group">
                    <label for="contactTags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="contactTags" placeholder="æœ‹å‹,åŒäº‹,å®¶äºº...">
                </div>
                <div class="form-group">
                    <label for="contactNotes">å¤‡æ³¨</label>
                    <textarea id="contactNotes" rows="3" placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeModal('contactModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveContact()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="modal" id="contactSelectorModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="selectorModalTitle">é€‰æ‹©è”ç³»äºº</h2>
            <button class="modal-close" onclick="closeModal('contactSelectorModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="selector-search">
                <input type="text" id="contactSearch" placeholder="æœç´¢è”ç³»äºº..." oninput="filterContacts()">
            </div>
            <div class="selector-list" id="contactSelectorList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const recentContacts = {{ recent_contacts|tojson }};
const activityData = {{ activity_data|tojson }};

function getGreeting() {
    const hour = new Date().getHours();
    if (hour < 6) return "å¤œçŒ«å­";
    if (hour < 12) return "æ—©ä¸Šå¥½";
    if (hour < 14) return "ä¸­åˆå¥½";
    if (hour < 18) return "ä¸‹åˆå¥½";
    return "æ™šä¸Šå¥½";
}

function showNewContactModal() {
    document.getElementById('modalTitle').textContent = 'æ–°å»ºè”ç³»äºº';
    document.getElementById('contactId').value = '';
    document.getElementById('contactForm').reset();
    document.getElementById('contactModal').classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

function viewContact(contactId) {
    window.location.href = `/profile/${contactId}`;
}

let allContacts = [];
let pendingAction = null;

async function selectContactForAction(action) {
    pendingAction = action;
    const titles = {
        'import': 'é€‰æ‹©è”ç³»äººå¯¼å…¥èŠå¤©è®°å½•',
        'analysis': 'é€‰æ‹©è”ç³»äººè¿›è¡ŒAIåˆ†æ',
        'export': 'é€‰æ‹©è”ç³»äººå¯¼å‡ºæ•°æ®'
    };
    document.getElementById('selectorModalTitle').textContent = titles[action];
    document.getElementById('contactSelectorModal').classList.add('show');
    document.getElementById('contactSearch').value = '';
    
    await loadContactsForSelector();
}

async function loadContactsForSelector() {
    const listEl = document.getElementById('contactSelectorList');
    listEl.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    try {
        const response = await fetch('/api/contacts');
        const data = await response.json();
        allContacts = data.contacts || [];
        renderContactSelectorList(allContacts);
    } catch (error) {
        console.error('Error loading contacts:', error);
        listEl.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
    }
}

function renderContactSelectorList(contacts) {
    const listEl = document.getElementById('contactSelectorList');
    
    if (contacts.length === 0) {
        listEl.innerHTML = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°è”ç³»äºº</div>';
        return;
    }
    
    listEl.innerHTML = contacts.map(contact => `
        <div class="selector-item" onclick="executeAction(${contact.id})">
            <div class="selector-avatar">
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(contact.name[0])}&background=fff&color=4a6cf7&size=40" alt="${contact.name}">
            </div>
            <div class="selector-info">
                <span class="selector-name">${contact.name}</span>
                <span class="selector-meta">${contact.chat_count || 0} æ¡æ¶ˆæ¯</span>
            </div>
            ${contact.has_analysis ? '<span class="selector-badge analyzed">å·²åˆ†æ</span>' : '<span class="selector-badge pending">å¾…åˆ†æ</span>'}
        </div>
    `).join('');
}

function filterContacts() {
    const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
    const filtered = allContacts.filter(contact => 
        contact.name.toLowerCase().includes(searchTerm)
    );
    renderContactSelectorList(filtered);
}

function executeAction(contactId) {
    closeModal('contactSelectorModal');
    
    const actionUrls = {
        'import': `/labeling/${contactId}`,
        'analysis': `/profile/${contactId}`,
        'export': `/export/${contactId}`
    };
    
    window.location.href = actionUrls[pendingAction];
}

async function saveContact() {
    const data = {
        name: document.getElementById('contactName').value,
        avatar: document.getElementById('contactAvatar').value,
        tags: document.getElementById('contactTags').value,
        notes: document.getElementById('contactNotes').value
    };
    
    if (!data.name) {
        alert('è¯·è¾“å…¥è”ç³»äººå§“å');
        return;
    }
    
    try {
        const response = await fetch('/api/contacts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            closeModal('contactModal');
            window.location.href = `/labeling/${result.contact.id}`;
        } else {
            alert('ä¿å­˜å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ä¿å­˜å¤±è´¥');
    }
}

let activityChart = null;

function updateActivityChart() {
    const range = document.getElementById('activityRange').value;
    const ctx = document.getElementById('activityCanvas').getContext('2d');
    
    const labels = [];
    const data = [];
    
    for (let i = parseInt(range) - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
        labels.push(dateStr);
        
        const found = activityData.find(d => d.date === date.toISOString().split('T')[0]);
        data.push(found ? found.count : 0);
    }
    
    if (activityChart) {
        activityChart.destroy();
    }
    
    activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æ¶ˆæ¯æ•°',
                data: data,
                borderColor: '#4a6cf7',
                backgroundColor: 'rgba(74, 108, 247, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 7
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    updateActivityChart();
});
</script>
{% endblock %}

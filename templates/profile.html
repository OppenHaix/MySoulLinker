{% extends "base.html" %}

{% block title %}{{ contact.name }}çš„åˆ†æç»“æœ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <div class="breadcrumb">
            <a href="{{ url_for('contacts_page') }}">è”ç³»äºº</a>
            <span class="separator">/</span>
            <span>{{ contact.name }}</span>
        </div>
        <div class="header-content">
            <div class="avatar-section">
                <img src="{{ contact.avatar if contact.avatar and contact.avatar != 'https://ui-avatars.com/api/?name=?&background=random&color=fff&size=128' else 'https://ui-avatars.com/api/?name=' + contact.name[:1] + '&background=fff&color=4a6cf7&size=128' }}" alt="{{ contact.name }}" class="profile-avatar">
            </div>
            <div class="info-section">
                <h1>{{ contact.name }}</h1>
                {% if contact.tags %}
                <div class="tags">
                    {% for tag in contact.tags.split(',') %}
                    <span class="tag">{{ tag.strip() }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="contact-stats-row">
                    <div class="contact-stat">
                        <span class="stat-number">{{ chat_logs|length }}</span>
                        <span class="stat-desc">æ¶ˆæ¯</span>
                    </div>
                    <div class="contact-stat">
                        <span class="stat-number">{{ contact.sessions|default(0) }}</span>
                        <span class="stat-desc">ä¼šè¯</span>
                    </div>
                    <div class="contact-stat">
                        <span class="stat-number">{{ contact.active_days|default(0) }}</span>
                        <span class="stat-desc">æ´»è·ƒå¤©</span>
                    </div>
                    <div class="contact-stat">
                        <span class="stat-number">{{ contact.analysis_count|default(0) }}</span>
                        <span class="stat-desc">åˆ†ææ¬¡æ•°</span>
                    </div>
                </div>
                {% if contact.notes %}
                <p class="notes">{{ contact.notes }}</p>
                {% endif %}
            </div>
            <div class="actions-section">
                <a href="{{ url_for('labeling_page', contact_id=contact.id) }}" class="btn">
                    <span class="btn-icon">ğŸ“¥</span> å¯¼å…¥æ–°å¯¹è¯
                </a>
                <a href="{{ url_for('export_page', contact_id=contact.id) }}" class="btn btn-primary">
                    <span class="btn-icon">ğŸ“¤</span> å¯¼å‡ºæ•°æ®
                </a>
            </div>
        </div>
        
        {% if contact.last_active %}
        <div class="header-footer">
            <span class="last-active-date">
                <span class="icon">ğŸ•</span> æœ€è¿‘æ´»è·ƒ: {{ contact.last_active }}
            </span>
            {% if contact.relationship_trend %}
            <span class="relationship-trend {{ contact.relationship_trend }}">
                {% if contact.relationship_trend == 'up' %}ğŸ“ˆ å…³ç³»å‡æ¸©{% elif contact.relationship_trend == 'down' %}ğŸ“‰ å…³ç³»é™æ¸©{% else %}â¡ï¸ å…³ç³»ç¨³å®š{% endif %}
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="profile-tabs">
        <button class="tab-btn active" data-tab="overview">
            <span class="tab-icon">ğŸ“Š</span> æ¦‚è§ˆ
        </button>
        <button class="tab-btn" data-tab="traits">
            <span class="tab-icon">ğŸ§ </span> æ€§æ ¼ç‰¹è´¨
        </button>
        <button class="tab-btn" data-tab="interests">
            <span class="tab-icon">ğŸ¯</span> å…´è¶£åˆ†æ
        </button>
        <button class="tab-btn" data-tab="guide">
            <span class="tab-icon">ğŸ’¡</span> ç›¸å¤„æŒ‡å—
        </button>
        <button class="tab-btn" data-tab="chats">
            <span class="tab-icon">ğŸ’¬</span> åŸå§‹å¯¹è¯
        </button>
        <button class="tab-btn" data-tab="timeline">
            <span class="tab-icon">ğŸ“…</span> äº’åŠ¨æ—¶é—´çº¿
        </button>
    </div>

    <div class="tab-content">
        <div class="tab-panel active" id="overview">
            {% if analysis %}
            <div class="overview-grid">
                <div class="summary-card">
                    <div class="summary-header">
                        <span class="summary-icon">âœ¨</span>
                        <h3>AI æ€»ç»“</h3>
                    </div>
                    <p class="summary-text">{{ analysis.summary }}</p>
                    <div class="summary-meta">
                        <span class="meta-item">
                            <span class="label">åˆ†ææ—¶é—´</span>
                            <span class="value">{{ analysis.created_at|default('æœªçŸ¥') }}</span>
                        </span>
                        <span class="meta-item">
                            <span class="label">åŸºäº</span>
                            <span class="value">{{ analysis.message_count|default(0) }} æ¡æ¶ˆæ¯</span>
                        </span>
                    </div>
                </div>
                
                <div class="radar-container">
                    <div class="chart-header">
                        <h3>æ€§æ ¼é›·è¾¾å›¾</h3>
                        <div class="chart-legend">
                            <span class="legend-item"><span class="legend-dot"></span> å¯¹æ–¹</span>
                            <span class="legend-item"><span class="legend-dot me"></span> æˆ‘</span>
                        </div>
                    </div>
                    <div id="radarChart" class="chart-container"></div>
                </div>
                
                <div class="keywords-container">
                    <div class="chart-header">
                        <h3>å…´è¶£å…³é”®è¯</h3>
                        <span class="keyword-count" id="keywordCount">0 ä¸ªæ ‡ç­¾</span>
                    </div>
                    <div id="wordCloud" class="wordcloud-container"></div>
                </div>
                
                <div class="stats-card">
                    <h3>æ¶ˆæ¯åˆ†å¸ƒ</h3>
                    <div id="messageChart" class="mini-chart"></div>
                    <div class="distribution-stats">
                        <div class="dist-item">
                            <span class="dist-label">å¯¹æ–¹</span>
                            <span class="dist-value" id="otherPercent">0%</span>
                            <span class="dist-count" id="otherCount">0 æ¡</span>
                        </div>
                        <div class="dist-item">
                            <span class="dist-label">æˆ‘</span>
                            <span class="dist-value" id="mePercent">0%</span>
                            <span class="dist-count" id="meCount">0 æ¡</span>
                        </div>
                    </div>
                </div>
                
                <div class="quick-insights">
                    <h3>å¿«é€Ÿæ´å¯Ÿ</h3>
                    <div class="insights-list" id="quickInsights">
                        <div class="insight-item">
                            <span class="insight-icon">â°</span>
                            <span class="insight-text">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="empty-analysis">
                <div class="empty-icon">ğŸ”</div>
                <h3>è¿˜æ²¡æœ‰åˆ†æç»“æœ</h3>
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè®©AIåˆ†æè¿™æ®µå…³ç³»</p>
                <button class="btn btn-primary btn-large" onclick="startAnalysis()">
                    <span class="btn-icon">ğŸ¤–</span> å¼€å§‹AIåˆ†æ
                </button>
                <p class="analysis-info">
                    åŸºäº {{ chat_logs|length }} æ¡èŠå¤©è®°å½•ï¼Œå°†ç”Ÿæˆæ€§æ ¼åˆ†æã€å…´è¶£æ ‡ç­¾å’Œç›¸å¤„å»ºè®®
                </p>
            </div>
            {% endif %}
        </div>

        <div class="tab-panel" id="traits">
            {% if analysis %}
            <div class="traits-detail">
                <div class="trait-category">
                    <div class="category-header">
                        <span class="category-icon">ğŸ¯</span>
                        <h3>æ ¸å¿ƒç‰¹è´¨</h3>
                    </div>
                    <div class="trait-list" id="coreTraitsList"></div>
                </div>
                <div class="trait-category">
                    <div class="category-header">
                        <span class="category-icon">ğŸƒâ€â™‚ï¸</span>
                        <h3>è¡Œä¸ºåå¥½</h3>
                    </div>
                    <div class="trait-list" id="behaviorList"></div>
                </div>
                <div class="trait-category">
                    <div class="category-header">
                        <span class="category-icon">ğŸ‘¥</span>
                        <h3>ç¤¾äº¤äº’åŠ¨</h3>
                    </div>
                    <div class="trait-list" id="socialList"></div>
                </div>
                <div class="trait-category">
                    <div class="category-header">
                        <span class="category-icon">ğŸ§ </span>
                        <h3>è®¤çŸ¥æ€ç»´</h3>
                    </div>
                    <div class="trait-list" id="cognitiveList"></div>
                </div>
            </div>
            {% else %}
            <div class="no-data-state">
                <span class="no-data-icon">ğŸ”’</span>
                <p>è¯·å…ˆè¿›è¡ŒAIåˆ†æä»¥æŸ¥çœ‹è¯¦ç»†ç‰¹è´¨</p>
                <button class="btn btn-primary" onclick="startAnalysis()">å¼€å§‹åˆ†æ</button>
            </div>
            {% endif %}
        </div>

        <div class="tab-panel" id="interests">
            {% if analysis %}
            <div class="interests-detail">
                <div class="interest-card">
                    <div class="card-icon">ğŸ”¥</div>
                    <h3>é«˜é¢‘è¯é¢˜</h3>
                    <p class="card-desc">èŠå¤©ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„è¯é¢˜</p>
                    <div class="interest-tags" id="highFrequencyTopics"></div>
                </div>
                <div class="interest-card">
                    <div class="card-icon">ğŸ’¡</div>
                    <h3>å…´è¶£é¢†åŸŸ</h3>
                    <p class="card-desc">å¯¹æ–¹æ„Ÿå…´è¶£çš„è¯é¢˜æ–¹å‘</p>
                    <div class="interest-tags" id="interestsList"></div>
                </div>
                <div class="interest-card">
                    <div class="card-icon">ğŸ¨</div>
                    <h3>ç”Ÿæ´»æ–¹å¼</h3>
                    <p class="card-desc">ä»èŠå¤©ä¸­æ¨æ–­çš„ç”Ÿæ´»ä¹ æƒ¯</p>
                    <div class="lifestyle-content" id="lifestyleContent"></div>
                </div>
                <div class="interest-card">
                    <div class="card-icon">ğŸ“</div>
                    <h3>è¡¨è¾¾ç‰¹ç‚¹</h3>
                    <p class="card-desc">èŠå¤©é£æ ¼å’Œç”¨è¯ä¹ æƒ¯</p>
                    <div class="expression-content" id="expressionContent"></div>
                </div>
            </div>
            {% else %}
            <div class="no-data-state">
                <span class="no-data-icon">ğŸ”’</span>
                <p>è¯·å…ˆè¿›è¡ŒAIåˆ†æä»¥æŸ¥çœ‹å…´è¶£åˆ†æ</p>
                <button class="btn btn-primary" onclick="startAnalysis()">å¼€å§‹åˆ†æ</button>
            </div>
            {% endif %}
        </div>

        <div class="tab-panel" id="guide">
            {% if analysis %}
            <div class="guide-detail">
                <div class="guide-section dos">
                    <div class="section-header">
                        <span class="section-icon">âœ…</span>
                        <h3>åº”è¯¥åšçš„äº‹</h3>
                    </div>
                    <p class="section-desc">æ ¹æ®åˆ†æç»“æœï¼Œè¿™äº›è¡Œä¸ºä¼šè®©å¯¹æ–¹æ„Ÿåˆ°èˆ’é€‚</p>
                    <ul id="dosList"></ul>
                </div>
                <div class="guide-section donts">
                    <div class="section-header">
                        <span class="section-icon">âŒ</span>
                        <h3>ä¸åº”è¯¥åšçš„äº‹</h3>
                    </div>
                    <p class="section-desc">è¿™äº›è¡Œä¸ºå¯èƒ½ä¼šè®©å¯¹æ–¹æ„Ÿåˆ°ä¸é€‚</p>
                    <ul id="dontsList"></ul>
                </div>
                <div class="guide-section tips">
                    <div class="section-header">
                        <span class="section-icon">ğŸ’¬</span>
                        <h3>è¯é¢˜æ¨è</h3>
                    </div>
                    <p class="section-desc">å¯ä»¥å°è¯•èŠè¿™äº›è¯é¢˜</p>
                    <ul id="topicSuggestions"></ul>
                </div>
                <div class="guide-section gifts">
                    <div class="section-header">
                        <span class="section-icon">ğŸ</span>
                        <h3>ç¤¼ç‰©/å…³å¿ƒå»ºè®®</h3>
                    </div>
                    <p class="section-desc">æ ¹æ®å¯¹æ–¹å…´è¶£ç»™å‡ºçš„å»ºè®®</p>
                    <ul id="giftSuggestions"></ul>
                </div>
            </div>
            {% else %}
            <div class="no-data-state">
                <span class="no-data-icon">ğŸ”’</span>
                <p>è¯·å…ˆè¿›è¡ŒAIåˆ†æä»¥æŸ¥çœ‹ç›¸å¤„æŒ‡å—</p>
                <button class="btn btn-primary" onclick="startAnalysis()">å¼€å§‹åˆ†æ</button>
            </div>
            {% endif %}
        </div>

        <div class="tab-panel" id="chats">
            <div class="chats-toolbar">
                <div class="toolbar-left">
                    <label class="select-all-label">
                        <input type="checkbox" id="selectAllChats" onchange="toggleSelectAllChats()">
                        <span>å…¨é€‰</span>
                    </label>
                    <div class="selected-info">
                        <span id="selectedCount">å·²é€‰æ‹© 0 æ¡</span>
                    </div>
                </div>
                <div class="toolbar-actions">
                    <button class="btn btn-primary btn-small" id="analyzeSelectedBtn" onclick="analyzeSelectedMessages()" disabled>
                        <span class="btn-icon">ğŸ¤–</span> åˆ†æé€‰ä¸­
                    </button>
                    <button class="btn btn-small" onclick="toggleChatViewMode()">
                        <span class="btn-icon" id="viewModeIcon">ğŸ“‹</span>
                        <span id="viewModeText">ç´§å‡‘è§†å›¾</span>
                    </button>
                </div>
                <div class="toolbar-filters">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="chatSearch" placeholder="æœç´¢å¯¹è¯å†…å®¹..." oninput="filterChats()">
                    </div>
                    <select id="chatDateFilter" class="date-filter" onchange="filterChats()">
                        <option value="all">æ‰€æœ‰æ—¥æœŸ</option>
                    </select>
                </div>
            </div>
            <div class="chats-wrapper">
                <div class="chats-container" id="chatsContainer">
                    {% set ns = namespace(last_date='') %}
                    {% for log in chat_logs %}
                    {% if log.chat_date.strftime('%Y-%m-%d') != ns.last_date %}
                    <div class="chat-date-group" data-date="{{ log.chat_date.strftime('%Y-%m-%d') }}">
                        <div class="date-divider">
                            <span class="date-badge">{{ log.chat_date.strftime('%mæœˆ%dæ—¥') }}</span>
                            <span class="date-weekday">{{ ['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'][log.chat_date.weekday()] }}</span>
                        </div>
                        {% set ns.last_date = log.chat_date.strftime('%Y-%m-%d') %}
                        {% endif %}
                        <div class="chat-item {{ 'me' if log.speaker == 'æˆ‘' else 'other' }}" data-date="{{ log.chat_date.strftime('%Y-%m-%d') }}" data-time="{{ log.chat_date.strftime('%H:%M') }}" data-id="{{ log.id }}">
                            <label class="chat-checkbox">
                                <input type="checkbox" class="chat-select-checkbox" value="{{ log.id }}" onchange="updateSelectedCount()">
                            </label>
                            <div class="chat-bubble">
                                <div class="bubble-header">
                                    <span class="speaker-avatar {{ 'me' if log.speaker == 'æˆ‘' else 'other' }}">{{ log.speaker[:1] }}</span>
                                    <span class="speaker-name">{{ log.speaker }}</span>
                                    <span class="chat-time">{{ log.chat_date.strftime('%H:%M') }}</span>
                                </div>
                                <p class="chat-content">{{ log.content }}</p>
                            </div>
                        </div>
                        {% if loop.last or chat_logs[loop.index].chat_date.strftime('%Y-%m-%d') != log.chat_date.strftime('%Y-%m-%d') %}
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="no-data-state">
                        <span class="no-data-icon">ğŸ’¬</span>
                        <p>è¿˜æ²¡æœ‰èŠå¤©è®°å½•</p>
                        <a href="{{ url_for('labeling_page', contact_id=contact.id) }}" class="btn btn-primary">å¯¼å…¥èŠå¤©</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="tab-panel" id="timeline">
            <div class="timeline-layout">
                <div class="timeline-main">
                    <div class="timeline-header">
                        <div class="header-left">
                            <h3>äº’åŠ¨æ—¶é—´çº¿</h3>
                            <p class="header-desc">æŸ¥çœ‹è¿‘6ä¸ªæœˆçš„äº’åŠ¨æ´»è·ƒåº¦</p>
                        </div>
                        <div class="timeline-stats">
                            <div class="tl-stat">
                                <div class="stat-icon">ğŸ“…</div>
                                <div class="stat-content">
                                    <span class="tl-stat-value">{{ contact.active_days|default(0) }}</span>
                                    <span class="tl-stat-label">æ´»è·ƒå¤©æ•°</span>
                                </div>
                            </div>
                            <div class="tl-stat">
                                <div class="stat-icon">âš¡</div>
                                <div class="stat-content">
                                    <span class="tl-stat-value">{{ contact.avg_response_time|default('N/A') }}</span>
                                    <span class="tl-stat-label">å¹³å‡å“åº”</span>
                                </div>
                            </div>
                            <div class="tl-stat">
                                <div class="stat-icon">ğŸ”¥</div>
                                <div class="stat-content">
                                    <span class="tl-stat-value">{{ contact.longest_streak|default(0) }}</span>
                                    <span class="tl-stat-label">æœ€é•¿è¿ç»­</span>
                                </div>
                            </div>
                            <div class="tl-stat highlight">
                                <div class="stat-icon">ğŸ’¬</div>
                                <div class="stat-content">
                                    <span class="tl-stat-value">{{ chat_logs|length }}</span>
                                    <span class="tl-stat-label">æ€»æ¶ˆæ¯æ•°</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-visual" id="timelineVisual">
                        <div class="heatmap-container">
                            <div class="heatmap-header">
                                <span class="heatmap-title">æ´»è·ƒåº¦çƒ­åŠ›å›¾</span>
                                <div class="timeline-legend">
                                    <span class="legend-item"><span class="legend-color" style="background: #e8f5e9"></span> æ— </span>
                                    <span class="legend-item"><span class="legend-color low"></span> 1-3</span>
                                    <span class="legend-item"><span class="legend-color medium"></span> 4-10</span>
                                    <span class="legend-item"><span class="legend-color high"></span> 10+</span>
                                </div>
                            </div>
                            <div class="timeline-heatmap" id="timelineHeatmap">
                                <p class="timeline-placeholder">åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="timeline-sidebar">
                    <div class="activity-summary">
                        <h4>äº’åŠ¨æ¦‚å†µ</h4>
                        <div class="summary-list" id="activitySummary">
                            <div class="summary-item">
                                <span class="item-icon">ğŸ“ˆ</span>
                                <span class="item-value" id="peakDay">-</span>
                                <span class="item-label">æœ€æ´»è·ƒæ—¥</span>
                            </div>
                            <div class="summary-item">
                                <span class="item-icon">ğŸ•</span>
                                <span class="item-value" id="peakHour">-</span>
                                <span class="item-label">æ´»è·ƒæ—¶æ®µ</span>
                            </div>
                            <div class="summary-item">
                                <span class="item-icon">ğŸ“Š</span>
                                <span class="item-value" id="avgDaily">-</span>
                                <span class="item-label">æ—¥å‡æ¶ˆæ¯</span>
                            </div>
                            <div class="summary-item">
                                <span class="item-icon">ğŸ“†</span>
                                <span class="item-value" id="activeWeeks">-</span>
                                <span class="item-label">æ´»è·ƒå‘¨æ•°</span>
                            </div>
                        </div>
                    </div>
                    <div class="recent-activity">
                        <h4>æœ€è¿‘äº’åŠ¨</h4>
                        <div class="activity-list" id="recentActivity">
                            <p class="empty-state">æš‚æ— æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not analysis %}
    <div class="analysis-section">
        <button class="btn btn-primary btn-large" onclick="startAnalysis()">
            <span class="btn-icon">ğŸ¤–</span> å¼€å§‹AIåˆ†æ
        </button>
        <p class="analysis-hint">åˆ†æç°æœ‰ {{ chat_logs|length }} æ¡èŠå¤©è®°å½•ï¼Œç”Ÿæˆæ€§æ ¼åˆ†ææŠ¥å‘Š</p>
    </div>
    {% endif %}
</div>

<div class="modal" id="analysisModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>AIåˆ†æä¸­...</h2>
            <button class="modal-close" onclick="cancelAnalysis()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="analysis-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="analysisProgress"></div>
                </div>
                <span class="progress-text" id="progressText">0%</span>
            </div>
            <div class="token-stats">
                <div class="token-item">
                    <span class="token-label">å·²ç”Ÿæˆ Tokens</span>
                    <span class="token-value" id="generatedTokens">0</span>
                </div>
                <div class="token-item">
                    <span class="token-label">æ€» Tokens</span>
                    <span class="token-value" id="totalTokens">0</span>
                </div>
            </div>
            <div class="loading-spinner" id="analysisSpinner"></div>
            <p id="analysisStatus">æ­£åœ¨åˆ†æèŠå¤©è®°å½•...</p>
            <div class="analysis-steps">
                <div class="step-item active" id="step1">
                    <span class="step-check">â—‹</span> æ”¶é›†æ•°æ®
                </div>
                <div class="step-item" id="step2">
                    <span class="step-check">â—‹</span> åˆ†æç‰¹è´¨
                </div>
                <div class="step-item" id="step3">
                    <span class="step-check">â—‹</span> ç”Ÿæˆå»ºè®®
                </div>
            </div>
            <p class="hint" id="analysisHint">AIæ­£åœ¨å®æ—¶ç”Ÿæˆåˆ†æç»“æœï¼Œè¯·ç¨å€™...</p>
            
            <div class="raw-data-section" id="rawDataSection" style="display: none;">
                <div class="raw-data-header">
                    <h3>åŸå§‹åˆ†ææ•°æ®</h3>
                    <button class="btn btn-sm" onclick="toggleRawData()">æ”¶èµ·/å±•å¼€</button>
                </div>
                <pre class="raw-data-content" id="rawDataContent"></pre>
            </div>
            
            <div class="analysis-actions" id="analysisActions" style="display: none;">
                <button class="btn btn-primary" onclick="finishAnalysis()">å®Œæˆ</button>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_js %}
<script src="https://testingcf.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
{% endblock %}
